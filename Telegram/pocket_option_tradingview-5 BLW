import configparser
#from curses.ascii import ESC
from logging import exception
from wsgiref.simple_server import WSGIRequestHandler
from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support.ui import Select
from selenium.webdriver.support import expected_conditions as EC
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.common.action_chains import ActionChains    
from selenium.webdriver.common.keys import Keys

import time, random
from configparser import ConfigParser
from telethon import TelegramClient
from telethon import events
import os, re, platform
import time
import asyncio
import configparser
import datetime


if platform.system() == 'Windows':
    os.chdir('C:\\Python\\Telegram')
elif platform.system() == 'Linux':
    os.chdir('/github/Python/Telegram')

if platform.system() == 'Windows':
    chrome_path = 'C:\\Python\\chromedriver.exe'
elif platform.system() == 'Linux':
    chrome_path = '/github/Python/chromedriver'

def clicker(element_locator):
    try:
        click=driver.find_element(By.XPATH, element_locator)
        click.click()
    
    except Exception as e:
        print(e)

def enter(param,xpath):
    credential=driver.find_element(By.XPATH, xpath)
    #credential.clear()
    credential.send_keys(param)

def change_to_fixed_expiration():
        check_timer = driver.find_element(By.XPATH,'//*[@id="put-call-buttons-chart-1"]/div/div[1]/div[1]/div[1]')
        if 'utc' in str(check_timer.text).lower():
            #change to fixed duration
            clicker('//*[@id="put-call-buttons-chart-1"]/div/div[1]/div[1]/div[2]/div[2]/div/a')
        print('Changed to Fixed Duration')

def reset_timer():
    try:
        clicker('//*[@class="value__val"]')
        time.sleep(1)
        WebDriverWait(driver,10).until(EC.element_to_be_clickable((By.XPATH, '//div[text()="M5"]'))).click()

    except Exception as e:
        print ('error in reset function', e)

def set_minute_timer(time):
    try:
        clicker ('//*[@id="put-call-buttons-chart-1"]/div/div[1]/div[1]/div[2]/div[1]/div')
        WebDriverWait(driver, 1).until(EC.element_to_be_clickable((By.XPATH, '//*[@id="modal-root"]/div[2]/div/div/div[1]/div[2]/div/input'))).click()
        ActionChains(driver).send_keys(Keys.BACKSPACE).send_keys(Keys.BACKSPACE).send_keys(time).perform()
        WebDriverWait(driver, 1).until(EC.element_to_be_clickable((By.XPATH, '//*[@id="modal-root"]/div[2]/div/div/div[1]/div[3]/div/input'))).click()
        ActionChains(driver).send_keys(Keys.BACKSPACE).send_keys(Keys.BACKSPACE).send_keys(0).perform()   
        clicker('//*[@id="chart-1"]/canvas')    
        
    except Exception as e:
        print ('error in set minute timer', e)

def set_trade_amount_percent():
    amount = trading_balance()*trading_percent/100
    amount = f'{amount:04}'
    print (amount)
    try:
        print (amount)
        WebDriverWait(driver, 1).until(EC.element_to_be_clickable((By.XPATH, '//*[@id="put-call-buttons-chart-1"]/div/div[1]/div[2]/div[2]/div[1]/div/input'))).click()
        ActionChains(driver).send_keys(Keys.BACKSPACE).send_keys(Keys.BACKSPACE).send_keys(Keys.BACKSPACE).send_keys(Keys.BACKSPACE).perform()
        ActionChains(driver).send_keys(amount[0]).send_keys(amount[1]).send_keys(amount[2]).send_keys(amount[3]).perform()   
        clicker('//*[@id="chart-1"]/canvas')    
        
    except Exception as e:
        print ('error in set trade amount', e)

def compare_payouts(currency_list):
    global payout_path
    try:
        payout_list = []
#        payout_value_path = '//*[@id="put-call-buttons-chart-1"]/div/div[2]/div[1]/div[1]/div[2]/div/div[1]/span'
        for i in currency_list:
            prepare(i)
            payout_list.append(float(driver.find_element(By.XPATH, payout_path).text[1:-1]))
        choice = currency_list[(payout_list.index(max(payout_list)))]
        print (choice)
        return choice

    except Exception as e:
        print ('There is an issue with the compare payout function', e)

def check_payout():
    global payout_path, payout_threshold, ignore
    try:
        payout = driver.find_element(By.XPATH, payout_path)
        print(currency,':',payout.text[1:-1])
        if int(payout.text[1:-1]) < payout_threshold:
            #print ('Payout too low!!!')
            ignore = True
        else:
            ignore = False

    except Exception as e:
        print ('There is an issue with the check payout function', e)
    print ('Ignore: ',ignore)

def prepare(instrument):
    global ignore, trade_amount
    if ignore == False:
        try:
            #Select Instrument To Trade
            clicker('//*[@id="bar-chart"]/div/div/div[1]/div/div[1]/div[1]/div[1]/div/a/div/span')
            clicker('//*[@id="modal-root"]/div[2]/div/div/div[1]/div/div[1]/a[1]/span[2]')
            enter(instrument,'//*[@id="modal-root"]/div[2]/div/div/div[2]/div[1]/div[1]/input')
            try:
                WebDriverWait(driver, 1).until(EC.element_to_be_clickable((By.XPATH, '//*[@id="modal-root"]/div[2]/div/div/div[2]/div[2]/div/div/div[1]/ul/li/a/span[3]'))).click()
            except:
                ignore = True
                print ('Ignoring due to instrument unavailability')
            ActionChains(driver).send_keys(Keys.ESCAPE).perform()
            #reset_timer()
#            set_trade_amount_percent()
#            check_payout()
        except Exception as e:
            print ('There is an issue with the prepare function', e)
    

def pocket_option_trader(action, duration):
    if ignore == False:
        try:
            #Set Expiration
            #reset_timer()
            #set_minute_timer(duration)
            if action.lower() == 'buy' or action.lower() == 'call':
                print ('Its a CALL!!!!!!!')
                a = ActionChains(driver)
                a.key_down(Keys.SHIFT).send_keys('W').perform()
            elif action.lower() == 'sell' or action.lower() == 'put':
                print ('Its a PUT!!!!!!!')
                a = ActionChains(driver)
                a.key_down(Keys.SHIFT).send_keys('S').perform()
            return
            
        except Exception as e:
            print ('error in pocket_option_trader', e)


def trading_balance():
    #current = WebDriverWait(driver, 30).until(EC.presence_of_element_located((By.XPATH, '/html/body/div[4]/div[1]/header/div[2]/div[2]/div/a/span')))
    current = WebDriverWait(driver, 30).until(EC.presence_of_element_located((By.CLASS_NAME, 'balance_current')))
    return float(current.text[1:])


def random_break():
    time_choices = [3600,7200,1800]
    choice = random.choices(time_choices)
    print ('Break:', choice[0])
    print('Trading session completed, taking a break')
    time.sleep(choice[0])

def market_check():
    global otc, ignore
    if ignore == False:
        try:    
            market = driver.find_element(By.XPATH,'//*[@id="bar-chart"]/div/div/div[1]/div/div[1]/div[1]/div[1]/div/a/div/span')
        #    print (market.text)
            if 'otc' in market.text.lower():
                ignore = True
                print('Market Mismatch!!!')
            else:
                ignore = False    
        except Exception as e:
            print ('error in pocket_option_trader', e)

        

chrome_options = Options()
chrome_options.add_argument("--disable-extensions")
chrome_options.add_argument("--disable-gpu")
#chrome_options.add_argument("--no-sandbox") # linux only
#chrome_options.add_argument("--headless")
chrome_options = webdriver.ChromeOptions() 
chrome_options.add_argument("start-maximized")
chrome_options.add_experimental_option("excludeSwitches", ["enable-automation"])
chrome_options.add_experimental_option('useAutomationExtension', False)


pocket_options='https://pocketoption.com/en/login'
blw='https://www.blwsignalsgroup.com/login/'
five_mins_room = 'https://www.blwsignalsgroup.com/five-minutes-signals/'
demo_mode_path = '/html/body/div[4]/div[1]/header/div[2]/div[2]/div/div'
payout_path = '//*[@id="put-call-buttons-chart-1"]/div/div[2]/div[1]/div[1]/div[2]/div/div[1]/span'
currency = ''
trade_count = 0
session_trade_count = 20
loss_count = 0
payout_threshold = 69
session_balance = 0
session_initial_balance = 0
trading_percent = 5
target = 100
safe = 0
otc = False
ignore = False
current_trade = []


## Open Pocket Options

driver=webdriver.Chrome(executable_path=chrome_path,options=chrome_options)
driver.implicitly_wait(30)
driver.maximize_window()

driver.get(pocket_options)

enter('cciephantom@gmail.com','/html/body/div[2]/div[2]/div/div/div/div[3]/form/div[2]/div[1]/input')
enter('Ideraoluwa@01','/html/body/div[2]/div[2]/div/div/div/div[3]/form/div[2]/div[2]/input')
#enter('tejiri.fai1@gmail.com','/html/body/div[2]/div[2]/div/div/div/div[3]/form/div[2]/div[1]/input')
#enter('H27VGUJQ','/html/body/div[2]/div[2]/div/div/div/div[3]/form/div[2]/div[2]/input')
#enter('oghenetejiri_orukpe@yahoo.com','/html/body/div[2]/div[2]/div/div/div/div[3]/form/div[2]/div[1]/input')
#enter('rsBUlxEr','/html/body/div[2]/div[2]/div/div/div/div[3]/form/div[2]/div[2]/input')

WebDriverWait(driver, 10).until(EC.frame_to_be_available_and_switch_to_it((By.CSS_SELECTOR,"iframe[name^='a-'][src^='https://www.google.com/recaptcha/api2/anchor?']")))
WebDriverWait(driver, 10).until(EC.element_to_be_clickable((By.XPATH, "//span[@id='recaptcha-anchor']"))).click()

print('Captcha Button Done!!!')
press_key = input("Press Any Key To Continue...")

while True:
    initial_balance = trading_balance()
    if initial_balance == 0:
        continue
    else:
        break

print ('Initial Balance:',initial_balance,'\r', 'Target Balance:', ((target*initial_balance)/100)+initial_balance)
balance = trading_balance()
print (balance)
trade_amount = int(balance*trading_percent/100)
print(trade_amount)
set_trade_amount_percent()
change_to_fixed_expiration()
reset_timer()
print('Pocket Options Ready...')
print('Opening BLW Signals Group...')

# Open a new window
driver.execute_script("window.open('');")

# Switch to the new window and open new URL
driver.switch_to.window(driver.window_handles[1])


## Open BLW Signals Site

driver.get(blw)

enter('cciephantom','//*[@id="user_login"]')
enter('Ideraoluwa@01','//*[@id="user_pass"]')
#enter('tejiri.fai1@gmail.com','/html/body/div[2]/div[2]/div/div/div/div[3]/form/div[2]/div[1]/input')
#enter('H27VGUJQ','/html/body/div[2]/div[2]/div/div/div/div[3]/form/div[2]/div[2]/input')
#enter('oghenetejiri_orukpe@yahoo.com','/html/body/div[2]/div[2]/div/div/div/div[3]/form/div[2]/div[1]/input')
#enter('rsBUlxEr','/html/body/div[2]/div[2]/div/div/div/div[3]/form/div[2]/div[2]/input')


WebDriverWait(driver, 10).until(EC.frame_to_be_available_and_switch_to_it((By.CSS_SELECTOR,"iframe[name^='a-'][src^='https://www.google.com/recaptcha/api2/anchor?']")))
WebDriverWait(driver, 10).until(EC.element_to_be_clickable((By.XPATH, "//span[@id='recaptcha-anchor']"))).click()

print('Captcha Button Done!!!')
press_key = input("Press Any Key To Continue...")

print ('Switching to the 5mins room...')
driver.get(five_mins_room)

#closed_signals_path = '//*[@id="blw_closed_signals"]'
#closed_signals_list = driver.find_element(By.XPATH, closed_signals_path)
#print(closed_signals_list.text)
open_signals_path = '//*[@id="signals-layout"]/ul[1]' #//*[@id="signals-layout"]/ul[1]/p

while True:
    try:
        time.sleep(10)
        open_signal = WebDriverWait(driver, 20).until(EC.presence_of_element_located((By.XPATH,open_signals_path)))
        #print(open_signal.text)
        if 'trade' in open_signal.text.lower():
            print (open_signal.text.lower().split())
            signal_list = open_signal.text.lower().split()
            #signal_list = ['harry', 'audnzd', 'put', '5', 'minute', 'trade']
            currency = signal_list[1]
            action = signal_list[2]
            duration = 5
            time_left = signal_list[-1]
            if signal_list[:-1] == current_trade:
                print ('Trade Already Under Way...')
                continue
            else:
                driver.switch_to.window(driver.window_handles[0])
                print (currency, action, duration)
                prepare(currency)
                time.sleep(1)
                if ignore == False:
                    pocket_option_trader(action, duration)
                    current_trade = signal_list[:-1]
                time.sleep(int(duration)*60)
                driver.switch_to.window(driver.window_handles[1])
                driver.refresh()

        else:
            time.sleep(10)
#            continue

    except Exception as e:
        print(e)


    driver.switch_to.window(driver.window_handles[1])